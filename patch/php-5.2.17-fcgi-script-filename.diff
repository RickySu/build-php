diff --git a/sapi/cgi/cgi_main.c b/sapi/cgi/cgi_main.c
index 2c19083..c3b8c97 100644
--- a/sapi/cgi/cgi_main.c
+++ b/sapi/cgi/cgi_main.c
@@ -942,6 +942,7 @@ static void init_request_info(TSRMLS_D)
 	char *env_script_filename = sapi_cgibin_getenv("SCRIPT_FILENAME", sizeof("SCRIPT_FILENAME")-1 TSRMLS_CC);
 	char *env_path_translated = sapi_cgibin_getenv("PATH_TRANSLATED", sizeof("PATH_TRANSLATED")-1 TSRMLS_CC);
 	char *script_path_translated = env_script_filename;
+        int apache_was_here = 0;
 
 #if !DISCARD_PATH
 	/* some broken servers do not have script_filename or argv0
@@ -972,6 +973,60 @@ static void init_request_info(TSRMLS_D)
 		char *content_type = sapi_cgibin_getenv("CONTENT_TYPE", sizeof("CONTENT_TYPE")-1 TSRMLS_CC);
 		char *env_path_info = sapi_cgibin_getenv("PATH_INFO", sizeof("PATH_INFO")-1 TSRMLS_CC);
 		char *env_script_name = sapi_cgibin_getenv("SCRIPT_NAME", sizeof("SCRIPT_NAME")-1 TSRMLS_CC);
+
+#define APACHE_PROXY_FCGI_PREFIX "proxy:fcgi://"
+#define APACHE_PROXY_BALANCER_PREFIX "proxy:balancer://"
+                /* Fix proxy URLs in SCRIPT_FILENAME generated by Apache mod_proxy_fcgi and mod_proxy_balancer:
+                 *     proxy:fcgi://localhost:9000/some-dir/info.php/test?foo=bar
+                 *     proxy:balancer://localhost:9000/some-dir/info.php/test?foo=bar
+                 * should be changed to:
+                 *     /some-dir/info.php/test
+                 * See: http://bugs.php.net/bug.php?id=54152
+                 *      http://bugs.php.net/bug.php?id=62172
+                 *      https://issues.apache.org/bugzilla/show_bug.cgi?id=50851
+                 */
+                if (env_script_filename &&
+                        strncasecmp(env_script_filename, APACHE_PROXY_FCGI_PREFIX, sizeof(APACHE_PROXY_FCGI_PREFIX) - 1) == 0) {
+                        /* advance to first character of hostname */
+                        char *p = env_script_filename + (sizeof(APACHE_PROXY_FCGI_PREFIX) - 1);
+                        while (*p != '\0' && *p != '/') {
+                                p++;    /* move past hostname and port */
+                        }
+                        if (*p != '\0') {
+                                /* Copy path portion in place to avoid memory leak.  Note
+                                 * that this also affects what script_path_translated points
+                                 * to. */
+                                memmove(env_script_filename, p, strlen(p) + 1);
+                                apache_was_here = 1;
+                        }
+                        /* ignore query string if sent by Apache (RewriteRule) */
+                        p = strchr(env_script_filename, '?');
+                        if (p) {
+                                *p =0;
+                        }
+                }
+
+                if (env_script_filename &&
+                        strncasecmp(env_script_filename, APACHE_PROXY_BALANCER_PREFIX, sizeof(APACHE_PROXY_BALANCER_PREFIX) - 1) == 0) {
+                        /* advance to first character of hostname */
+                        char *p = env_script_filename + (sizeof(APACHE_PROXY_BALANCER_PREFIX) - 1);
+                        while (*p != '\0' && *p != '/') {
+                                p++;    /* move past hostname and port */
+                        }
+                        if (*p != '\0') {
+                                /* Copy path portion in place to avoid memory leak.  Note
+                                 * that this also affects what script_path_translated points
+                                 * to. */
+                                memmove(env_script_filename, p, strlen(p) + 1);
+                                apache_was_here = 1;
+                        }
+                        /* ignore query string if sent by Apache (RewriteRule) */
+                        p = strchr(env_script_filename, '?');
+                        if (p) {
+                                *p =0;
+                        }
+                }
+
 #if ENABLE_PATHINFO_CHECK
 		struct stat st;
 		char *env_redirect_url = sapi_cgibin_getenv("REDIRECT_URL", sizeof("REDIRECT_URL")-1 TSRMLS_CC);
